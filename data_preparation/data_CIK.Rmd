---
title: "Cook Inletkeeper Water Temps"
output:
  html_document: 
    df_print: paged
    fig_width: 10
    fig_height: 6
    fig_caption: yes
    code_folding: hide
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(".."))



# load packages
library(tidyverse)
library(lubridate)
library(readr)
library(readxl)
library(hms)
library(plotly)
library(DT)
library(dataRetrieval)
```

# Metadata

AKOATS metadata

```{r}
akoats.meta <- read_excel("data/AKOATS_DATA_2020_Working.xlsx", sheet = "CONTINUOUS_DATA", col_types = "text") %>%
  select(seq_id,Agency_ID,Contact_person,SourceName,Contact_email,Contact_telephone,Latitude,Longitude,Sensor_accuracy,Waterbody_name) %>%
  rename(AKOATS_ID = seq_id,
         SiteID = Agency_ID) %>% 
  mutate(AKOATS_ID = as.numeric(AKOATS_ID),
         Latitude = as.numeric(Latitude),
         Longitude = as.numeric(Longitude))

akoats.meta

```

CIK metadata

Sue didn't provide lat/longs in her metadata file so need to try and match names in akoats. Sue provided lat/long for Ben Courtney Creek, Dan provided lat/long for Roadhouse creek.

```{r}

cik.meta <- akoats.meta %>%
  filter(SourceName == "CIK") %>% 
  select(SiteID, SourceName, Contact_person, Waterbody_name, Latitude, Longitude)

#remove sites in cook inlet.
cik.meta <- cik.meta[!grepl("CIK", cik.meta$SiteID),]

cik.meta <- bind_rows(cik.meta,
                      data.frame(SiteID = "Ben Courtney Creek",
                                 SourceName = "CIK",
                                 Contact_person = "Sue Mauger",
                                 Latitude = 59.272417,
                                 Longitude = -156.357567,
                                 Waterbody_name = "Ben Courtney Creek"))

cik.meta <- bind_rows(cik.meta,
                      data.frame(SiteID = "Roadhouse Creek",
                                 SourceName = "CIK",
                                 Contact_person = "Sue Mauger",
                                 Latitude = 59.7573,
                                 Longitude = -154.8499,
                                 Waterbody_name = "Roadhouse Creek"))

cik.meta <- cik.meta %>% 
  mutate(SiteID = case_when(grepl("Gibraltar", SiteID) ~ "Gibraltar River",
                            TRUE ~ SiteID))
  
saveRDS(cik.meta, "output/cik_metadata.rds")

```



# Data

Read in temp observation data from CIK folder

```{r}
cik.files <-list.files(path = paste0("data/CIK Bristol Bay village and lodge sites"),
               pattern = "*.xlsx", 
               full.names = T)

#remove metadata file
cik.files <- cik.files[!(grepl("CIK Bristol Bay village and lodge sites/CIK Bristol", cik.files))]


cik.data <- cik.files %>% 
  map_df(function(x) read_excel(x,skip = 1,col_names = F) %>% 
  mutate(file_name = gsub(".xlsx","",basename(x))))

cik.data <- cik.data %>% 
  mutate(sampleDate = as.Date(`...1`),
         sampleTime = as_hms(`...2`),
         Temperature = `...3`,
         SiteID = sub("\\_.*", "", file_name)) %>%  
  select(-`...1`, -`...2`, -`...3`, -`...4`, -`...5`) 

#fix site names. 
cik.data <- cik.data %>% 
  mutate(SiteID = case_when(grepl("Naknek", file_name) ~ "Big Creek_Naknek",
                            grepl("Roadhouse", file_name) ~ "Roadhouse Creek",
                            grepl("Panar", file_name) ~ "Panaruqak Creek",
                            TRUE ~ SiteID))


```

Summary csv to add as attributes to leaflet map.

```{r}
cik.data %>% 
  group_by(SiteID) %>% 
  summarize(startYear = min(year(sampleDate)),
            endYear = max(year(sampleDate)),
            totYears = length(unique(year(sampleDate)))) %>% 
  saveRDS("output/cik_data_summ.rds")

```

```{r}
cik.data %>% 
  saveRDS("output/cik_data.rds")
```

Perform a quick visualization to see extent and form of data
```{r}
cik.data %>%
  mutate(DT = parse_date_time(paste(sampleDate, sampleTime), "Y-m-d H:M:S")) %>%
  ggplot(aes(x = DT, y = Temperature)) +
  geom_point() +
  facet_wrap(~ SiteID) +
  ggtitle("Original Logger Data by Site and Year")

cik.data %>% distinct(SiteID)

```

# Data review

(Currently from Ben and not updated or run, all data from Sue has been QAed. Ben did not flag anything below.)

CIK QA methods describe having already deleted anomalous data.  However, we will more carefully examine data from a few sites to decide if it too should be excised.


Process to identify and remove erroneous data:

* Visually identify data that does not seem reasonable
* Plot unreasonable datasets by individual year and site
* Use an anti_join script process to assign a "useData = 0" value to erroneous data observations by start and end dateTime

```{r eval = FALSE}

# list of suspect sites to manually examine w/ ggplotly 
suspect.cik.sites <-data.frame(c("Ben Courtney Creek",
                                 "Gibraltar River"))
colnames(suspect.cik.sites) <- "SiteID"

# specify year or years to visualize
y <- c("2019","2020")

# create ggplotly chart
ggplotly(
  p <- cik.data %>%
  inner_join(suspect.cik.sites) %>%
  select(-sampleTime) %>%
  mutate(year = as.factor(year(sampleDate)),
         day = yday(sampleDate)) %>%
  group_by(day,SiteID,year) %>%
  summarise(daily_mean_Temperature = mean(Temperature)) %>%
  
  # modified SiteID one at a time here to visually inspect datasets
  filter(SiteID == "Gibraltar River"
         # put hash tag at next line to see all years for the site
         #,year %in% y
         ) %>%
  
  ggplot(aes(day,daily_mean_Temperature, color = year)) +
  geom_point() +
  facet_wrap(. ~ SiteID) +
  ggtitle("Daily Mean Data")
  )

```


Notes: 2019 Ben Courtney Creek: temps >20C looked potentially suspect, but closer visual examination does not suggest exposure or logger error.  2019 temps at Gibraltar River are of similar form, suggesting common pattern across sites in the region for that time period.


Assign "useData =1" for all CIK data
```{r eval = FALSE}
cik.data <- cik.data %>% mutate(useData = 1)
```


