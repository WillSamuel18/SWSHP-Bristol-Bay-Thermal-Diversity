---
title: "USFWS Water Temp Data Import"
output:
  html_document: 
    df_print: paged
    fig_width: 10
    fig_height: 6
    fig_caption: yes
    code_folding: hide
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: inline
---

Document last updated `r Sys.time()` by Rebecca Shaftel (rsshaftel@alaska.edu).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(".."))


# load packages
library(googledrive)
library(lubridate)
library(readr)
library(readxl)
library(hms)
library(plotly)
library(tidyverse)
```

Note that we need to get the knb download for Meg's data. And, the lake data that Meg provided are at 5 m. This might not match what we want for the growth analysis so follow up and see if they have a surface logger too.

# Metadata

Read in metadata and use to assign AKOATS_IDs. Note same metadata in both workbooks, only need one. Get sites from OSM as well.

```{r}
togiak1_metadata <- read_excel("data/FWS/Togiak_Oct2020_Part1.xlsx", sheet = "AKOATS_metadata") %>% 
  filter(!is.na(SourceName))

wrb_metadata <- read_excel("data/FWS/WRB_Oct2020.xlsx", sheet = "AKOATS_metadata", n_max = 15) %>% 
  mutate(SiteID = as.character(SiteID)) %>% 
  filter(Waterbody_name %in% c("Egegik River"))

osm_md <- read_excel("S:\\Stream Temperature Data\\USFWS Perdue - complete 2020\\OSM_Oct2020.xlsx", sheet = "OSM_Sites_AKOATS") %>% 
  filter(Agency_ID == "Newhalen River") %>% 
  mutate(AKOATS_ID = 1571)

# combine metadata sheets
fws.metadata <- bind_rows(togiak1_metadata, wrb_metadata) %>%
  select(SourceName, Contact_person, AKOATS_ID, SiteID, Waterbody_name, Waterbody_type, Sensor_Placement, Latitude, Longitude)

fws.metadata <- bind_rows(osm_md %>% select(SourceName, Contact_person, AKOATS_ID, SiteID = Agency_ID, Waterbody_name, Waterbody_type, Sensor_Placement, Latitude, Longitude), fws.metadata)

fws.metadata <- fws.metadata %>% 
  mutate(Waterbody_type = case_when(grepl("Stream", Waterbody_type) ~ "S",
                                    TRUE ~ Waterbody_type))

saveRDS(fws.metadata, "output/fws_metadata.rds")

```



# Data Import



Read in Excel files, one at a time.  Note: data is structured such that individual sites are separated by tabs, with one tab for metadata.

Read in "Togiak_Oct2020_Part1.xlsx"
```{r}

togiak1 <- "data/FWS/Togiak_Oct2020_Part1.xlsx"

sheets <- excel_sheets(togiak1)
sheets <- sheets[!grepl("metadata", sheets)] # filtering to remove the metadata sheet
tog1_dat <- tibble()
for(i in sheets){
  dat <- read_excel(togiak1, sheet = i, skip = 1, col_types = c("date", "date", "numeric"), na = "---", 
                    col_names = c("sampleDate", "sampleTime", "Temperature")) %>%
    mutate(SiteID = i)
  tog1_dat <- bind_rows(tog1_dat, dat)
}

tog1_dat
```


Read in "Togiak_Oct2020_Part2.xlsx"
```{r}
togiak2 <- "data/FWS/Togiak_Oct2020_Part2.xlsx"

sheets <- excel_sheets(togiak2)
sheets <- sheets[!grepl("metadata", sheets)] # filtering to remove the metadata sheet
tog2_dat <- tibble()
for(i in sheets){
  dat <- read_excel(togiak2, 
                    sheet = i, 
                    skip = 1, 
                    col_types = c("date", "date", "numeric"), na = "---",
                    col_names = c("sampleDate", "sampleTime", "Temperature")) %>%
    mutate(SiteID = i)
  tog2_dat <- bind_rows(tog2_dat, dat)
}

tog2_dat
```


Read in Egegik data, "WRB_Oct2020.xlsx"
```{r}
egegik <- read_excel("data/FWS/WRB_Oct2020.xlsx", sheet = "580223156504200", skip = 1, 
                    col_types = c("date", "date", "numeric"), na = "---", col_names = c("sampleDate", "sampleTime", "Temperature")) %>% 
  mutate(SiteID = "580223156504200")

egegik
```

Newhalen River data collected by OSM.

```{r}
newhalen <- read_excel("S:\\Stream Temperature Data\\USFWS Perdue - complete 2020\\OSM_Oct2020.xlsx", sheet = "Newhalen", col_names = TRUE,
                     col_types = c("date", "date", "numeric"), na = "---") 

newhalen <- newhalen %>% 
  select(sampleDate = Date, sampleTime = `Time (UTC -8:00)`, Temperature = `TW [Â°C]`) %>% 
  mutate(SiteID = "Newhalen River") 
```



Combine the three data sources and format as specified in Project_notes.Rmd
```{r}
fws.data <- bind_rows(tog1_dat, tog2_dat, egegik, newhalen) %>%
  mutate(Temperature = as.numeric(Temperature),
         sampleTime = hms::as_hms(sampleTime),
         sampleDate = as.Date(sampleDate)) %>%
  filter(!is.na(Temperature))

fws.data %>% 
  distinct(SiteID)

```

Join metadata to data to get the waterbody name for each site for figures.

```{r}
fws.data <- left_join(fws.data, fws.metadata %>% select(SiteID, Waterbody_name), by = "SiteID") 


```


Check to see what years of data we have and if we need to import knb data for FWS Bristol Bay. It looks like everything is in there.

```{r}
fws.data %>% 
  group_by(SiteID) %>% 
  summarize(min(year(sampleDate)), max(year(sampleDate)))

fws.metadata
```



Summary csv to add as attributes to leaflet map.

```{r}
fws.data %>% 
  group_by(SiteID, Waterbody_name) %>% 
  summarize(startYear = min(year(sampleDate)),
            endYear = max(year(sampleDate)),
            totYears = length(unique(year(sampleDate)))) %>% 
  saveRDS("output/fws_data_summ.rds")

```

Save data for summary table and figure.

```{r}
saveRDS(fws.data, "output/fws_data.rds")
```

# Save daily data and metadata

Save raw data for AKTEMP, which includes date and time. Save metadata file. Save daily data after screening for days with less than 90% of measurements.

This is really for AKSSF so not using lake sites right now. 

```{r save raw data}
source("W:/Github/AKSSF/helper_functions.R")

fws.metadata 

save_metadata_files(fws.metadata %>% anti_join(lake_sites), "fws_bb")

lake_sites <- fws.metadata %>% 
  filter(Waterbody_type == "L") %>% 
  distinct(SiteID)

fws.data.streams <- fws.data %>% 
  mutate(UseData = 1) %>% 
  anti_join(lake_sites) 

fws.data.streams %>% 
  distinct(SiteID) %>% # 23 sites
  left_join(fws.metadata) %>% # all 23 are in metadata - note that 3 sites not in akoats may not be distinct sites 
  filter(Waterbody_type == "S") # all are streams, which is correct.

save_aktemp_files(fws.data.streams, "fws_bb")

fws.daily <- temp_msmt_freq(fws.data.streams) %>% daily_screen(.)

save_daily_files(fws.daily, "fws_bb")
```



