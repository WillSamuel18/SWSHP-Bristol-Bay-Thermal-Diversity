---
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
title: "Bristol Bay Temperature Data Summary"
output:
  html_document: 
    df_print: paged
    fig_width: 10
    fig_height: 6
    fig_caption: yes
    code_folding: hide
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: inline
---

Document created by Benjamin Meyer (benjamin.meyer.ak@gmail.com) and last updated `r Sys.time()` by Rebecca Shaftel (rsshaftel@alaska.edu). 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# clear environment
rm(list=ls())

# load packages
library(tidyverse)
library(lubridate)
library(readr)
library(readxl)
library(hms)
library(plotly)
library(DT)
library(leaflet)


```

stopping notes - need to go through nps data. also wrb could have data for egegik, maybe others in knb download. meg just provided post 2017 data for them. maybe focus on nps data for streams and beaches first, then do lake arrays later. 


# Cook Inletkeeper

Sue provided temperature data collected in partnership with lodges and villages around Bristol Bay from 16 sites from 2014 to 2020. Data were reviewed prior to submission and bad data removed.

```{r}
cik.data <- read_rds("output/cik_data.rds")

cik.data.summary <- cik.data %>%
  mutate(year = year(sampleDate)) %>%
  group_by(SiteID, year) %>%
  summarize(meanTemp = mean(Temperature, na.rm = T),
            maxTemp = max(Temperature, na.rm = T),
            minTemp = min(Temperature, na.rm = T),
            sdTemp = sd(Temperature, na.rm = T),
            n_obs = n())

cik.data.summary %>%
  datatable() %>%
  formatRound(columns=c("meanTemp","maxTemp","minTemp","sdTemp"), digits=2)
```

```{r cik_figure, fig.height=10, fig.width=8}

cik.data %>%
  group_by(SiteID, sampleDate) %>% 
  summarize(meanT = mean(Temperature)) %>%
  complete(SiteID, sampleDate = seq.Date(min(sampleDate), max(sampleDate), by = "day")) %>% 
  mutate(year = year(sampleDate),
         mo_day = format(sampleDate, "%m-%d")) %>% 
  ggplot(aes(x = as.Date(mo_day, format = "%m-%d"), y = meanT, color = as.factor(year))) +
  geom_line() +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  facet_wrap(~ SiteID) +
  labs(x = "Date", y = "Mean Daily Temperature", color = "Year",
       title = "CIK Original Logger Data by Site and Year") +
  theme_bw() +
  theme(legend.position = "bottom")
```

# ACCS

UAA has data from 14 sites in the Kvichak and Nushagak watersheds from 2013 to 2019. Data shown here are through 2017. These data are part of the KNB archive through the SASAP project. 

```{r}
accs.data <- read_rds("output/accs_data.rds")

accs.data.summary <- accs.data %>%
  filter(UseData == 1) %>% 
  mutate(year = year(sampleDate)) %>%
  group_by(SiteID, Waterbody_name, year) %>%
  summarize(meanTemp = mean(Temperature, na.rm = T),
            maxTemp = max(Temperature, na.rm = T),
            minTemp = min(Temperature, na.rm = T),
            sdTemp = sd(Temperature, na.rm = T),
            n_obs = n())

accs.data.summary %>%
  datatable() %>%
  formatRound(columns=c("meanTemp","maxTemp","minTemp","sdTemp"), digits=2)
```

```{r accs_figure, fig.width=8, fig.height=10}

accs.data %>%
  filter(UseData == 1) %>% 
  group_by(Waterbody_name, SiteID, sampleDate) %>% 
  summarize(meanT = mean(Temperature)) %>%
  complete(SiteID, sampleDate = seq.Date(min(sampleDate), max(sampleDate), by = "day")) %>% 
  mutate(year = year(sampleDate),
         mo_day = format(sampleDate, "%m-%d"),
         facetLabel = paste0(Waterbody_name, " (", SiteID, ")")) %>% 
  ggplot(aes(x = as.Date(mo_day, format = "%m-%d"), y = meanT, color = as.factor(year))) +
  geom_line() +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
    facet_wrap(~ facetLabel, labeller = label_wrap_gen(width = 22, multi_line = TRUE)) +
  labs(x = "Date", y = "Mean Daily Temperature", color = "Year", 
       title = "ACCS Original Logger Data by Site and Year") +
  theme_bw() +
  theme(legend.position = "bottom")

```

# USFWS

Meg provided data from 23 sites in the Togiak Refuge and also from the Egegik River from 2001 to 2019. 

```{r}
fws.data <- read_rds("output/fws_data.rds")

fws.data.summary <- fws.data %>%
  mutate(year = year(sampleDate)) %>%
  group_by(SiteID, Waterbody_name, year) %>%
  summarize(meanTemp = mean(Temperature, na.rm = T),
            maxTemp = max(Temperature, na.rm = T),
            minTemp = min(Temperature, na.rm = T),
            sdTemp = sd(Temperature, na.rm = T),
            n_obs = n())

fws.data.summary %>%
  datatable() %>%
  formatRound(columns=c("meanTemp","maxTemp","minTemp","sdTemp"), digits=2)
```

```{r fws_figure, fig.height=15, fig.width=8}

fws.data %>%
  group_by(Waterbody_name, SiteID, sampleDate) %>% 
  summarize(meanT = mean(Temperature)) %>%
  complete(SiteID, sampleDate = seq.Date(min(sampleDate), max(sampleDate), by = "day")) %>% 
  mutate(year = year(sampleDate),
         mo_day = format(sampleDate, "%m-%d"),
         facetLabel = paste0(Waterbody_name, " (", SiteID, ")")) %>% 
  ggplot(aes(x = as.Date(mo_day, format = "%m-%d"), y = meanT, color = as.factor(year))) +
  geom_line() +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  facet_wrap(~ facetLabel, labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(x = "Date", y = "Mean Daily Temperature", color = "Year", 
       title = "FWS Original Logger Data by Site and Year") +
  theme_bw() +
  theme(legend.position = "bottom")
  

```

# UW

Daniel Schindler and Jackie Carter provided data from the University of Washington for 70 stream and river sites from 2006 to 2020. Jackie will send over all of their lake data once they receive the loggers back from 2020.

```{r}
uw.data <- read_rds("output/uw_data.rds")

uw.data.summary <- uw.data %>%
  filter(UseData == 1) %>% 
  mutate(year = year(sampleDate)) %>%
  group_by(SiteID, year) %>%
  summarize(meanTemp = mean(Temperature, na.rm = T),
            maxTemp = max(Temperature, na.rm = T),
            minTemp = min(Temperature, na.rm = T),
            sdTemp = sd(Temperature, na.rm = T),
            n_obs = n())

uw.data.summary %>%
  datatable() %>%
  formatRound(columns=c("meanTemp","maxTemp","minTemp","sdTemp"), digits=2)
```

```{r uw_figure, fig.height=20, fig.width=10}

uw.data %>%
  filter(UseData == 1) %>% 
  group_by(SiteID, sampleDate) %>% 
  summarize(meanT = mean(Temperature)) %>%
  complete(SiteID, sampleDate = seq.Date(min(sampleDate), max(sampleDate), by = "day")) %>% 
  mutate(year = year(sampleDate),
         mo_day = format(sampleDate, "%m-%d")) %>% 
  ggplot(aes(x = as.Date(mo_day, format = "%m-%d"), y = meanT, color = as.factor(year))) +
  geom_line() +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  facet_wrap(~ SiteID, labeller = label_wrap_gen(width = 15, multi_line = TRUE)) +
  labs(x = "Date", y = "Mean Daily Temperature", color = "Year") +
  theme_bw() +
  ggtitle("UW Original Logger Data by Site and Year")

```


# Map of sites and years of data

This leaflet map shows the location of all of the sites that we have data for. Selecting each marker will show the data provider, the site name, the start year, the end year, and the number of years of data. Currently, only streams and rivers sites have been included.

```{r uw}
uw.md <- read_rds("output/uw_metadata.rds")
uw.sum <- read_rds("output/uw_data_summ.rds")
uw.dat <- left_join(uw.md, uw.sum)

```

```{r accs}
accs.md <- read_rds("output/accs_metadata.rds")
accs.sum <- read_rds("output/accs_data_summ.rds")
accs.dat <- left_join(accs.md, accs.sum)

```

```{r cik}
cik.md <- read_rds("output/cik_metadata.rds")
cik.sum <- read_rds("output/cik_data_summ.rds")
cik.dat <- left_join(cik.md, cik.sum)

```

```{r fws}
fws.md <- read_rds("output/fws_metadata.rds")
fws.sum <- read_rds("output/fws_data_summ.rds")
fws.dat <- left_join(fws.md, fws.sum)

```



```{r combine}
all.dat <- bind_rows(uw.dat, accs.dat, cik.dat, fws.dat)
```


```{r leaflet map}

# create map
leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  #fitBounds(-150, 60.04,-149.0, 60.02) %>%
  #setView(-150.210169, 60.487694, zoom = 8) %>%
  addMarkers(lng = all.dat$Longitude, lat = all.dat$Latitude,
             popup = paste("SiteID = ", all.dat$SiteID, "<br>",
                           "Data Source = ", all.dat$SourceName, "<br>",
                           "Start Year = ", all.dat$startYear, "<br>",
                           "End Year = ", all.dat$endYear, "<br>",
                           "Total Years of Data = ", all.dat$totYears, "<br>"))

```



