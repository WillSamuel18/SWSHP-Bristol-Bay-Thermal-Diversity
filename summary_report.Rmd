---
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
title: "Bristol Bay Temperature Data Summary"
output:
  html_document: 
    df_print: paged
    fig_width: 10
    fig_height: 6
    fig_caption: yes
    code_folding: hide
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: inline
---

Document last updated `r Sys.time()` by Rebecca Shaftel (rsshaftel@alaska.edu). 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)


# load packages
library(tidyverse)
library(lubridate)
library(readr)
library(readxl)
library(hms)
library(plotly)
library(DT)
library(leaflet)
library(sf)


```

```{r}
daily.dat <- readRDS("output/daily.dat.rds")
md_sf <- readRDS("output/md_sf.rds")

daily.dat %>% distinct(SiteID)
```



# Map of sites and years of data

This leaflet map shows the location of all of the sites that we have data for. Selecting each marker will show the data provider, the site name, the start year, the end year, and the number of years of data. Currently, only streams and rivers sites have been included.

```{r site summary}
daily.summ <- left_join(daily.dat, md_sf %>% select(SiteID, Waterbody_name, Name)) %>% 
  filter(month(sampleDate) %in% 6:9) %>% 
  count(Name, SiteID, Waterbody_name, year = year(sampleDate)) 

site.summ <- daily.summ %>% 
  filter(n > .7*122) %>% 
  group_by(SiteID, Waterbody_name) %>% 
  summarize(start_year = min(year),
            end_year = max(year),
            total_years = n()) 
  
md_sf <- merge(md_sf, site.summ)

ggplot() +
  geom_sf(data = md_sf)
```



```{r leaflet map}

leaflet(md_sf) %>% 
  addTiles() %>% 
  addMarkers(popup = paste("SiteID = ", md_sf$SiteID, "<br>",
                           "Waterbody Name = ", md_sf$Waterbody_name, "<br>",
                           "Data Source = ", md_sf$SourceName, "<br>",
                           "Start Year = ", md_sf$start_year, "<br>",
                           "End Year = ", md_sf$end_year, "<br>",
                           "Total Years of Data = ", md_sf$total_years, "<br>"))

```



# Summary of complete dataset

Data availability figure

```{r}


p3 <- daily.summ %>%
  ggplot() +
  geom_tile(aes(x = year, y = reorder(SiteID, desc(SiteID)), fill = n)) +
  # scale_fill_gradient(limits = range(min(uw.summ$n), max(uw.summ$n))) +
  # coord_cartesian(xlim = c(2017,2020)) + 
  # geom_vline(aes(xintercept = 2016.5)) +
  facet_wrap(~HUC8_Name, scale = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom", axis.title.y = element_blank(), axis.text.y = element_blank()) 

p3

```
Distribution of sites with data from 2019.

```{r}
left_join()
```

Summary of sites by year.

```{r}
daily.summ %>%
  filter(n > .7*122) %>% 
  count(year) %>% 
  ggplot() +
  geom_point(aes(y = factor(year), x = n))
```


```{r create data filtered on complete years}

daily.dat2 <- left_join(daily.dat, md %>% select(SourceName, SiteID, Waterbody_name, HUC8_Name)) %>% 
  filter(month(sampleDate) %in% 6:9) %>% 
  group_by(SourceName, HUC8_Name, SiteID, Waterbody_name, Year = year(sampleDate)) %>% 
  mutate(yrCt = n(),
         Source = case_when(grepl("FWS|fws", SourceName) ~ "FWS",
                            grepl("uaa", SourceName) ~ "UAA",
                            grepl("nps", SourceName) ~ "NPS",
                            grepl("uw", SourceName) ~ "UW",
                            TRUE ~ SourceName)) %>% 
  filter(yrCt > .7*122) %>% 
  ungroup()
  
daily.dat2 %>% distinct(SourceName, Source)
md_sf %>% st_drop_geometry() %>%  distinct(SourceName)
```
# STOPPED HERE CAN UPDATE BELOW WITH PROVIDER NOW.


# Cook Inletkeeper

Sue Mauger provided temperature data collected in partnership with lodges and villages around Bristol Bay from 16 sites from 2014 to 2020. Data were reviewed prior to submission and bad data removed.

```{r}
cik.data <- read_rds("output/cik_data.rds")

cik.data.summary <- cik.data %>%
  mutate(year = year(sampleDate)) %>%
  group_by(SiteID, year) %>%
  summarize(meanTemp = mean(Temperature, na.rm = T),
            maxTemp = max(Temperature, na.rm = T),
            minTemp = min(Temperature, na.rm = T),
            sdTemp = sd(Temperature, na.rm = T),
            n_obs = n())

cik.data.summary %>%
  datatable() %>%
  formatRound(columns=c("meanTemp","maxTemp","minTemp","sdTemp"), digits=2)
```

```{r cik_figure, fig.height=10, fig.width=8}

cik.data %>%
  group_by(SiteID, sampleDate) %>% 
  summarize(meanT = mean(Temperature)) %>%
  complete(SiteID, sampleDate = seq.Date(min(sampleDate), max(sampleDate), by = "day")) %>% 
  mutate(year = year(sampleDate),
         mo_day = format(sampleDate, "%m-%d")) %>% 
  ggplot(aes(x = as.Date(mo_day, format = "%m-%d"), y = meanT, color = as.factor(year))) +
  geom_line() +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  facet_wrap(~ SiteID) +
  labs(x = "Date", y = "Mean Daily Temperature", color = "Year",
       title = "CIK Original Logger Data by Site and Year") +
  theme_bw() +
  theme(legend.position = "bottom")
```

# ACCS

UAA has data from 15 sites in the Kvichak and Nushagak watersheds from 2013 to 2019. All data have been reviewed. 

```{r}
accs.data <- read_rds("output/accs_data.rds")

accs.data.summary <- accs.data %>%
  # filter(UseData == 1) %>% 
  mutate(year = year(sampleDate)) %>%
  group_by(SiteID, Waterbody_name, year) %>%
  summarize(meanTemp = mean(Temperature, na.rm = T),
            maxTemp = max(Temperature, na.rm = T),
            minTemp = min(Temperature, na.rm = T),
            sdTemp = sd(Temperature, na.rm = T),
            n_obs = n())

accs.data.summary %>%
  datatable() %>%
  formatRound(columns=c("meanTemp","maxTemp","minTemp","sdTemp"), digits=2)
```

```{r accs_figure, fig.width=8, fig.height=10}

accs.data %>%
  # filter(UseData == 1) %>% 
  group_by(Waterbody_name, SiteID, sampleDate) %>% 
  summarize(meanT = mean(Temperature)) %>%
  complete(SiteID, sampleDate = seq.Date(min(sampleDate), max(sampleDate), by = "day")) %>% 
  mutate(year = year(sampleDate),
         mo_day = format(sampleDate, "%m-%d"),
         facetLabel = paste0(Waterbody_name, " (", SiteID, ")")) %>% 
  ggplot(aes(x = as.Date(mo_day, format = "%m-%d"), y = meanT, color = as.factor(year))) +
  geom_line() +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
    facet_wrap(~ facetLabel, labeller = label_wrap_gen(width = 22, multi_line = TRUE)) +
  labs(x = "Date", y = "Mean Daily Temperature", color = "Year", 
       title = "ACCS Original Logger Data by Site and Year") +
  theme_bw() +
  theme(legend.position = "bottom")

```

# NPS

Krista Bartz and Paul Gabriel provided data from 20 stream or lakeshore sites and also temperature data from depth arrays for 6 lakes. All data have been reviewed or clipped to June 1 - Sept 30 per input from Krista. The summary table and figure are based on the surface depths only for the lake arrays. It looks like the 0 meter depth is not always available so we may need to use the next depth for some of our analyses.

```{r}
nps.data <- read_rds("output/nps_data.rds")

# nps.data %>% distinct(SiteID, Waterbody_name)

nps.data.summary <- nps.data %>%
  filter(UseData == 1 & (is.na(Depth) | Depth == 0)) %>% 
  mutate(year = year(sampleDate)) %>%
  group_by(SiteID, Waterbody_name, year) %>%
  summarize(meanTemp = mean(Temperature, na.rm = T),
            maxTemp = max(Temperature, na.rm = T),
            minTemp = min(Temperature, na.rm = T),
            sdTemp = sd(Temperature, na.rm = T),
            n_obs = n())

nps.data.summary %>%
  datatable() %>%
  formatRound(columns=c("meanTemp","maxTemp","minTemp","sdTemp"), digits=2)
```

```{r nps_figure, fig.height=15, fig.width=8}

nps.data %>%
  filter(UseData == 1 & (is.na(Depth) | Depth == 0)) %>% 
  group_by(Waterbody_name, SiteID, sampleDate) %>% 
  summarize(meanT = mean(Temperature)) %>%
  complete(SiteID, sampleDate = seq.Date(min(sampleDate), max(sampleDate), by = "day")) %>%
  mutate(year = year(sampleDate),
         mo_day = format(sampleDate, "%m-%d"),
         facetLabel = paste0(Waterbody_name, " (", SiteID, ")")) %>% 
  ggplot(aes(x = as.Date(mo_day, format = "%m-%d"), y = meanT, color = as.factor(year))) +
  geom_line() +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  facet_wrap(~ facetLabel, labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(x = "Date", y = "Mean Daily Temperature", color = "Year", 
       title = "NPS Original Logger Data by Site and Year") +
  theme_bw() +
  theme(legend.position = "bottom")
  

```

# USFWS

Meg Perdue provided data from 23 sites in the Togiak Refuge and also from the Egegik River from 2001 to 2019. 

```{r}
fws.data <- read_rds("output/fws_data.rds")

fws.data.summary <- fws.data %>%
  mutate(year = year(sampleDate)) %>%
  group_by(SiteID, Waterbody_name, year) %>%
  summarize(meanTemp = mean(Temperature, na.rm = T),
            maxTemp = max(Temperature, na.rm = T),
            minTemp = min(Temperature, na.rm = T),
            sdTemp = sd(Temperature, na.rm = T),
            n_obs = n())

fws.data.summary %>%
  datatable() %>%
  formatRound(columns=c("meanTemp","maxTemp","minTemp","sdTemp"), digits=2)
```

```{r fws_figure, fig.height=15, fig.width=8}

fws.data %>%
  group_by(Waterbody_name, SiteID, sampleDate) %>% 
  summarize(meanT = mean(Temperature)) %>%
  complete(SiteID, sampleDate = seq.Date(min(sampleDate), max(sampleDate), by = "day")) %>% 
  mutate(year = year(sampleDate),
         mo_day = format(sampleDate, "%m-%d"),
         facetLabel = paste0(Waterbody_name, " (", SiteID, ")")) %>% 
  ggplot(aes(x = as.Date(mo_day, format = "%m-%d"), y = meanT, color = as.factor(year))) +
  geom_line() +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  facet_wrap(~ facetLabel, labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(x = "Date", y = "Mean Daily Temperature", color = "Year", 
       title = "FWS Original Logger Data by Site and Year") +
  theme_bw() +
  theme(legend.position = "bottom")
  

```

# UW

Daniel Schindler and Jackie Carter provided data from the University of Washington for 70 stream and river sites from 2006 to 2020. Jackie will send over all of their lake data once they receive the loggers back from 2020.

```{r}
uw.data <- read_rds("output/uw_data.rds")

uw.data.summary <- uw.data %>%
  filter(UseData == 1) %>% 
  mutate(year = year(sampleDate)) %>%
  group_by(SiteID, year) %>%
  summarize(meanTemp = mean(Temperature, na.rm = T),
            maxTemp = max(Temperature, na.rm = T),
            minTemp = min(Temperature, na.rm = T),
            sdTemp = sd(Temperature, na.rm = T),
            n_obs = n())

uw.data.summary %>%
  datatable() %>%
  formatRound(columns=c("meanTemp","maxTemp","minTemp","sdTemp"), digits=2)
```

```{r uw_figure, fig.height=30, fig.width=10}

uw.data %>%
  filter(UseData == 1) %>% 
  group_by(SiteID, sampleDate) %>% 
  summarize(meanT = mean(Temperature)) %>%
  complete(SiteID, sampleDate = seq.Date(min(sampleDate), max(sampleDate), by = "day")) %>% 
  mutate(year = year(sampleDate),
         mo_day = format(sampleDate, "%m-%d")) %>% 
  ggplot(aes(x = as.Date(mo_day, format = "%m-%d"), y = meanT, color = as.factor(year))) +
  geom_line() +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  facet_wrap(~ SiteID, labeller = label_wrap_gen(width = 15, multi_line = TRUE), ncol = 5) +
  labs(x = "Date", y = "Mean Daily Temperature", color = "Year") +
  theme_bw() +
  ggtitle("UW Original Logger Data by Site and Year")

```


